<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Dashboard ‚Äî SwapSkill</title>
<link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
<link rel="icon" type="image/png" href="logo.png">
<style>
:root {
  --primary: #3b82f6;
  --success: #22c55e;
  --danger: #ef4444;
  --bg: #0f172a;
  --text: #f8fafc;
  --glass: rgba(30, 41, 59, 0.7);
  --border: rgba(255, 255, 255, 0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }

body {
  background: radial-gradient(circle at top right, #1e293b, #0f172a);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* --- Header --- */
header {
  position: sticky; top: 0; z-index: 50;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.brand { 
  font-size: 18px; font-weight: 800; 
  background: linear-gradient(90deg, #60a5fa, #3b82f6); 
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
  text-decoration: none;
}
.header-right { display: flex; gap: 8px; align-items: center; }

/* Buttons & Links */
.btn {
  padding: 8px 14px; border-radius: 10px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; 
  text-decoration:none; display:inline-flex; align-items:center; justify-content:center; white-space: nowrap;
}
.btn-ghost { background: rgba(255,255,255,0.08); color: #cbd5e1; border: 1px solid var(--border); }
.btn-ghost:hover { background: rgba(255,255,255,0.15); color: #fff; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #2563eb; }

/* --- Layout --- */
.container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 0 20px;
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 24px;
  width: 100%;
}

/* --- Profile Card --- */
.profile-card {
  background: var(--glass);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 24px;
  text-align: center;
}

.avatar-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto 16px; flex-shrink: 0; }
.avatar {
  width: 100%; height: 100%; border-radius: 50%; overflow: hidden;
  border: 3px solid rgba(255,255,255,0.1);
  background: linear-gradient(180deg,#c7d2fe,#eef2ff);
  display: flex; align-items: center; justify-content: center; 
  font-size: 36px; font-weight: 800; color: #334155; object-fit: cover;
}
.chooseAvatarBtn {
  position: absolute; bottom: 0; right: 0;
  background: var(--primary); color: #fff; border: none; width: 32px; height: 32px; border-radius: 50%;
  cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.profile-name { font-size: 18px; font-weight: 700; color: #fff; margin:0; display: flex; align-items: center; justify-content: center; gap: 5px; }
.verified-badge { color: #3b82f6; font-size: 16px; cursor: help; }

.profile-username { font-size: 14px; color: #94a3b8; margin-top: 2px; }
.profile-bio { font-size: 13px; color: #cbd5e1; margin: 12px 0; line-height: 1.5; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; }

/* Toggle Switch */
.switch-container { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 12px 0; }
.switch { position: relative; display: inline-block; width: 34px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #22c55e; }
input:checked + .slider:before { transform: translateX(14px); }

/* Skill Chips */
.skill-tags { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 20px; }
.skill-tag { background: rgba(59,130,246,0.15); color: #60a5fa; padding: 4px 10px; border-radius: 20px; font-size: 11px; border: 1px solid rgba(59,130,246,0.3); }

.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 0; }
.stat-box { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 10px; border: 1px solid var(--border); }
.stat-val { font-size: 18px; font-weight: 700; color: #fff; }
.stat-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

.quick-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; }
.quick-actions .btn { width: 100%; padding: 12px; }

/* --- Panels --- */
.section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
.panel {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 16px;
  margin-bottom: 24px;
}

.list-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 12px;
  margin-bottom: 8px;
}
.item-left { display: flex; align-items: center; gap: 12px; }
.item-avatar { width: 40px; height: 40px; border-radius: 50%; background: #334155; object-fit: cover; }
.item-info b { display: block; font-size: 14px; color: #f1f5f9; }
.item-info span { font-size: 12px; color: #94a3b8; }

/* --- Modals --- */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  backdrop-filter: blur(5px); z-index: 100;
  display: none; align-items: center; justify-content: center;
}
.modal-backdrop.show { display: flex; animation: fadeIn 0.2s; }
.modal-content {
  background: #1e293b; border: 1px solid var(--border);
  width: 90%; max-width: 400px; padding: 24px; border-radius: 24px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: scaleIn 0.2s;
  max-height: 85vh; overflow-y: auto;
}
.modal-content h3 { margin-bottom: 16px; color: #fff; text-align:center; }

.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 6px; }
.form-group input, .form-group select {
  width: 100%; padding: 12px; font-size: 16px; 
  background: rgba(0,0,0,0.3); border: 1px solid var(--border);
  border-radius: 12px; color: #fff; outline: none;
}
.avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
.avatar-grid img { width: 100%; aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; background:#334155; }
.avatar-grid img:hover { border-color: var(--primary); transform: scale(1.1); }

.history-label { font-size: 12px; color: #94a3b8; margin: 15px 0 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

/* Upload Section */
.upload-section {
    text-align: center;
    border-bottom: 1px solid var(--border);
    padding-bottom: 20px;
    margin-bottom: 10px;
}
.upload-status {
    font-size: 12px; color: #3b82f6; margin-top: 8px; display: none;
}

/* --- Toast & Offline --- */
.offline-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: #ef4444; color: white; padding: 8px 16px; border-radius: 20px;
  font-weight: 600; font-size: 13px; display: none; z-index: 200;
}
#toast {
  position: fixed; bottom: 24px; right: 24px;
  background: #0f172a; border: 1px solid var(--border);
  color: #fff; padding: 12px 20px; border-radius: 12px;
  transform: translateY(100px); transition: 0.3s; z-index: 200;
}
#toast.show { transform: translateY(0); }

/* --- MOBILE OPTIMIZATION --- */
@media(max-width: 900px){
  header { padding: 10px 14px; }
  .header-right { gap: 6px; }
  .btn-ghost { padding: 6px 10px; font-size: 11px; }
  .brand { font-size: 16px; }

  .container { grid-template-columns: 1fr; padding: 16px; width: 100%; gap: 16px; }
  
  .profile-card {
    display: flex; align-items: center; text-align: left; gap: 16px; padding: 16px;
  }
  .avatar-wrapper { width: 60px; height: 60px; margin: 0; }
  .chooseAvatarBtn { width: 24px; height: 24px; font-size: 12px; right: -4px; bottom: -4px; }
  
  .profile-bio, .stats-grid, .switch-container, .skill-tags { display: none; } 
  .profile-info { flex: 1; }
  .quick-actions { display: none; } 
  
  #mobileQuickRequestBtn { display: block !important; width: 100%; margin-top:10px; padding:12px; }
}

@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes scaleIn { from{transform:scale(0.95)} to{transform:scale(1)} }
</style>
</head>
<body>

<header>
  <a href="index.html" class="brand">SwapSkill</a>
  <div class="header-right">
  <div class="header-right">
    <div class="notif-wrapper" style="position:relative;">
        <button id="notifBtn" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">üîî</button>
        <div id="notifBadge" style="position:absolute;top:-5px;right:-5px;background:#ef4444;color:white;font-size:10px;padding:2px 5px;border-radius:50%;display:none;">0</div>
        <div id="notifDropdown" style="position:absolute;top:30px;right:0;width:250px;background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:none;z-index:100;overflow:hidden;">
            <div id="notifList" style="max-height:300px;overflow-y:auto;">
                <div style="padding:15px;text-align:center;color:#64748b;font-size:12px;">No new notifications</div>
            </div>
        </div>
    </div>
</div>
    <a href="browse.html" class="btn btn-ghost">Browse</a>
    <a href="request.html" class="btn btn-ghost">Requests</a>
    <a href="chat.html" class="btn btn-primary">Messages</a>
    <button class="btn btn-ghost" style="color:#ef4444;" id="logoutBtn">Exit</button>
  </div>
</header>

<div class="container">
  
  <aside>
    <div class="profile-card">
      <div class="avatar-wrapper">
        <div class="avatar" id="avatarEl"></div> 
        <button class="chooseAvatarBtn" id="chooseAvatarBtn">‚úé</button>
      </div>
      <div class="profile-info">
        <h3 class="profile-name" id="nameEl">Loading...</h3>
        <p class="profile-username" id="usernameEl">@...</p>
        <a href="editprofile.html" class="btn btn-ghost" style="margin-top:6px; font-size:11px; padding:4px 10px;">Edit Profile</a>
      </div>
      
      <div class="profile-bio" id="bioEl">No bio yet.</div>
      
      <div class="switch-container">
        <span style="font-size:12px; color:#94a3b8">Available:</span>
        <label class="switch">
          <input type="checkbox" id="availabilityToggle">
          <span class="slider round"></span>
        </label>
      </div>

      <div class="skill-tags" id="skillTags"></div>

      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-val" id="scoreEl">0.0</div>
          <div class="stat-label">Score</div>
        </div>
        <div class="stat-box">
          <div class="stat-val" id="levelEl">-</div>
          <div class="stat-label">Level</div>
        </div>
        <div class="stat-box">
          <div class="stat-val" id="pendingCount">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-box">
          <div class="stat-val" id="acceptedCount">0</div>
          <div class="stat-label">Accepted</div>
        </div>
      </div>
      
      <div class="quick-actions">
        <button class="btn btn-primary" id="quickRequestBtn">Create Request</button>
        <a href="request.html" class="btn btn-ghost">üìÇ My Requests</a>
        
        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;">
        <button class="btn btn-ghost" id="deleteAccBtn" style="color: #ef4444; border-color: rgba(239,68,68,0.3);">
            üóëÔ∏è Delete Account
        </button>
      </div>
    </div>
    
    <button class="btn btn-primary" id="mobileQuickRequestBtn" style="width:100%; margin-top:10px; display:none; background:#3b82f6;">+ New Request</button>
  </aside>

  <main>
    <div class="section-title">
      Your Sessions
    </div>
    <div class="panel" id="sessionsPanel">
      <div id="sessionsList">
        <div style="color:#64748b;text-align:center;padding:20px;font-size:14px">Loading sessions...</div>
      </div>
    </div>

    <div class="section-title">
      Pending Requests
      <a href="request.html" class="btn btn-ghost" style="font-size:12px;padding:4px 10px">View All</a>
    </div>
    <div class="panel" id="pendingPanel">
      <div id="requestsList">
        <div style="color:#64748b;text-align:center;padding:20px;font-size:14px">No pending requests</div>
      </div>
    </div>

    <div class="section-title">Suggested Matches</div>
    <div class="panel" id="matchesPanel">
      <div id="matchesList">
        <div style="color:#64748b;text-align:center;padding:20px;font-size:14px">Loading matches...</div>
      </div>
    </div>
    
    <a href="browse.html" class="btn btn-primary" style="width:100%; padding:14px; background:#22c55e; margin-top:10px;">üîç Browse New People</a>

  </main>
</div>

<div class="modal-backdrop" id="avatarModal">
  <div class="modal-content">
    <h3>Update Profile Picture</h3>
    <div class="upload-section">
        <p style="font-size:13px; color:#94a3b8; margin-bottom:10px;">Upload Custom Photo</p>
        <input type="file" id="customUploadInput" accept="image/*" style="display:none">
        <button class="btn btn-primary" id="triggerUploadBtn">üìÅ Select from Device</button>
        <div id="uploadStatus" class="upload-status">Uploading to ImgBB...</div>
    </div>
    <div id="historySection" style="display:none">
        <div class="history-label">Your Uploads</div>
        <div class="avatar-grid" id="historyGrid"></div>
    </div>
    <div class="history-label">Default Avatars</div>
    <div class="avatar-grid" id="avatarGrid"></div>
    <button class="btn btn-ghost" style="width:100%;margin-top:16px" id="closeAvatarModal">Close</button>
  </div>
</div>

<div class="modal-backdrop" id="requestModal">
  <div class="modal-content">
    <h3>Create Request</h3>
    <div class="form-group">
      <label>I Offer</label>
      <input type="text" id="reqSkillOffer" placeholder="e.g. Web Dev">
    </div>
    <div class="form-group">
      <label>I Want</label>
      <input type="text" id="reqSkillWant" placeholder="e.g. Design">
    </div>
    <div class="form-group">
      <label>Level</label>
      <select id="reqLevel">
        <option>Beginner</option>
        <option>Intermediate</option>
        <option>Advanced</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px">
      <button class="btn btn-ghost" style="flex:1" id="closeRequestModal">Cancel</button>
      <button class="btn btn-primary" style="flex:1" id="sendRequestBtn">Send</button>
    </div>
  </div>
</div>

<div class="offline-bar" id="offlineBar">‚ö†Ô∏è No Internet Connection</div>
<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, query, where, getDocs,
  onSnapshot, addDoc, setDoc, serverTimestamp, orderBy, updateDoc, arrayUnion, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwrZVBhR0VSbkbiktvkOsW3iSYJ6PFJ9A",
  authDomain: "swapskill.web.app",
  projectId: "swapskill-6e456",
  storageBucket: "swapskill-6e456.firebasestorage.app",
  messagingSenderId: "692315602994",
  appId: "1:692315602994:web:65cd15b1eafe9d7d133c2b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const messaging = getMessaging(app);
// --- NOTIFICATION SYSTEM ---
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');
const notifBadge = document.getElementById('notifBadge');
const notifList = document.getElementById('notifList');

// Toggle Dropdown
notifBtn.onclick = (e) => {
    e.stopPropagation();
    notifDropdown.style.display = notifDropdown.style.display === 'block' ? 'none' : 'block';
};

// Close on click outside
window.addEventListener('click', () => notifDropdown.style.display = 'none');

// Listen for Notifications
function subscribeNotifications(uid) {
    // Listen for PENDING requests directed at ME
    const q = query(collection(db, 'requests'), where('receiverId', '==', uid), where('status', '==', 'pending'));
    
    onSnapshot(q, snap => {
        const count = snap.size;
        
        // Update Badge
        if (count > 0) {
            notifBadge.style.display = 'block';
            notifBadge.innerText = count;
        } else {
            notifBadge.style.display = 'none';
        }

        // Update List
        notifList.innerHTML = '';
        if (count === 0) {
            notifList.innerHTML = '<div style="padding:15px;text-align:center;color:#64748b;font-size:12px;">No new notifications</div>';
        } else {
            snap.forEach(d => {
                const r = d.data();
                const item = document.createElement('div');
                item.style.padding = '12px';
                item.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div style="font-size:13px;color:#fff;"><b>${r.senderName}</b> sent a request</div>
                    <div style="font-size:11px;color:#94a3b8;">${r.skillOffered} ‚áÑ ${r.skillRequested}</div>
                `;
                item.onclick = () => window.location.href = 'request.html'; // Go to requests page
                notifList.appendChild(item);
            });
        }
    });
}

// Call this in your onAuthStateChanged:
// subscribeNotifications(user.uid);
// --- NOTIFICATIONS ---
async function requestPermissionAndSaveToken(uid) {
  try {
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      const currentToken = await getToken(messaging, { 
        vapidKey: 'BEDQw5wfw19EFI8BG6JACtf__dVe8DU0RrSqbtoXr25CwW065gitV9jyWlguT5ENoUHO4NrLS2iTxTfh6PdxMGw'
      });
      if (currentToken) await updateDoc(doc(db, 'users', uid), { fcmToken: currentToken });
    }
  } catch (err) { console.log('Token error', err); }
}

onMessage(messaging, (payload) => {
  new Notification(payload.notification.title, {
    body: payload.notification.body, icon: '/logo.png'
  });
});

if ('serviceWorker' in navigator) navigator.serviceWorker.register('/firebase-messaging-sw.js');

// --- CONSTANTS ---
const IMGBB_KEY = "23e893979642fe669cef61faaac3c779";
const toastEl = document.getElementById('toast');
const avatarEl = document.getElementById('avatarEl');
const nameEl = document.getElementById('nameEl');
const usernameEl = document.getElementById('usernameEl');
const bioEl = document.getElementById('bioEl');
const requestsList = document.getElementById('requestsList');
const sessionsList = document.getElementById('sessionsList');
const matchesList = document.getElementById('matchesList');
const tagsContainer = document.getElementById('skillTags');

let currentUID = null;
let myData = null;

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), 3000);
}

// --- AVATAR & UPLOAD ---
const avatarModal = document.getElementById('avatarModal');
const avatarGrid = document.getElementById('avatarGrid');
const historyGrid = document.getElementById('historyGrid');
const historySection = document.getElementById('historySection');
const fileInput = document.getElementById('customUploadInput');
const triggerUploadBtn = document.getElementById('triggerUploadBtn');
const uploadStatus = document.getElementById('uploadStatus');

function addToGrid(src, container) {
  const img = document.createElement('img');
  img.src = src;
  img.onclick = async ()=>{
    if(currentUID){
      await updateDoc(doc(db,'users',currentUID), { avatarUrl: src });
      toast('Avatar Updated'); avatarModal.classList.remove('show'); location.reload(); 
    }
  };
  container.appendChild(img);
}

const DEFAULT_AVATARS = [
  'avatars/a1.png', 'avatars/a2.png', 'avatars/a3.png', 'avatars/a4.png',
  'avatars/a5.png', 'avatars/a6.png', 'avatars/a7.png', 'avatars/a8.png'
];
DEFAULT_AVATARS.forEach(src => addToGrid(src, avatarGrid));

triggerUploadBtn.onclick = () => fileInput.click();

fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    uploadStatus.style.display = 'block'; triggerUploadBtn.disabled = true; triggerUploadBtn.textContent = "Uploading...";
    const formData = new FormData(); formData.append("image", file);
    try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
        const data = await res.json();
        if(data.success) {
            const newUrl = data.data.url;
            await updateDoc(doc(db, 'users', currentUID), { avatarUrl: newUrl, avatarHistory: arrayUnion(newUrl) });
            toast("Profile Picture Uploaded!"); avatarModal.classList.remove('show'); location.reload();
        } else { throw new Error("ImgBB upload failed"); }
    } catch (err) { console.error(err); toast("Upload Failed. Try a smaller image."); } 
    finally { uploadStatus.style.display = 'none'; triggerUploadBtn.disabled = false; triggerUploadBtn.textContent = "üìÅ Select from Device"; fileInput.value = ""; }
};

document.getElementById('chooseAvatarBtn').onclick = () => {
    if(myData && myData.avatarHistory && myData.avatarHistory.length > 0) {
        historyGrid.innerHTML = ''; historySection.style.display = 'block';
        [...myData.avatarHistory].reverse().forEach(src => addToGrid(src, historyGrid));
    } else { historySection.style.display = 'none'; }
    avatarModal.classList.add('show');
};
document.getElementById('closeAvatarModal').onclick = () => avatarModal.classList.remove('show');

// --- MAIN LOGIC ---
onAuthStateChanged(auth, async (user)=>{
  if(!user) return window.location.href = 'login.html';
  currentUID = user.uid;
  requestPermissionAndSaveToken(currentUID);
  loadProfile(); subscribeRequests(); loadSessions(); loadMatches();
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  try { await signOut(auth); window.location.href = 'login.html'; } catch (err) { toast("Logout failed."); }
});

function loadProfile(){
  onSnapshot(doc(db,'users',currentUID), async snap=>{
    if(!snap.exists()) return window.location.href='userprofile.html';
    myData = snap.data();

    // --- üö´ BAN & APPEAL LOGIC ---
    if(myData.isBanned === true) {
        const banReason = myData.banReason || "Violation of Community Guidelines";
        
        // Check for pending appeal
        const q = query(collection(db, "appeals"), where("userId", "==", currentUID), where("status", "==", "pending"));
        const snap = await getDocs(q);
        const hasPending = !snap.empty;

        document.body.innerHTML = `
            <div style="height:100vh;width:100vw;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0f172a;color:#ef4444;text-align:center;font-family:system-ui;padding:20px;">
                <div style="font-size:60px;margin-bottom:10px;">üö´</div>
                <h2 style="color:white;margin:0;">Account Suspended</h2>
                <p style="color:#94a3b8;margin-top:5px;max-width:400px;font-size:14px;">Reason: <strong style="color:#fff">${banReason}</strong></p>
                
                ${hasPending ? 
                    `<div style="margin-top:20px;padding:15px;background:rgba(245,158,11,0.1);border:1px solid #f59e0b;color:#f59e0b;border-radius:8px;font-size:14px;">
                        <strong>‚è≥ Appeal Under Review</strong><br>
                        We will notify you via your registered email once a decision is made.
                     </div>` 
                    : 
                    `<div style="margin-top:20px;width:100%;max-width:350px;">
                        <p style="color:#cbd5e1;font-size:13px;margin-bottom:8px;">Think this is a mistake? Submit an appeal:</p>
                        <textarea id="appealText" placeholder="Explain why you should be unbanned..." style="width:100%;height:80px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.3);color:white;font-size:13px;"></textarea>
                        <button id="submitAppealBtn" style="width:100%;background:#3b82f6;color:white;border:none;padding:12px;border-radius:8px;margin-top:10px;cursor:pointer;font-weight:bold;">Submit Appeal</button>
                     </div>`
                }
                
                <button onclick="location.reload()" style="background:transparent;color:#64748b;border:1px solid #334155;padding:8px 16px;border-radius:8px;margin-top:20px;cursor:pointer;font-size:12px;">Check Status / Refresh</button>
            </div>
        `;

        // Appeal Submit Logic
        if(!hasPending) {
            document.getElementById('submitAppealBtn').onclick = async () => {
                const reason = document.getElementById('appealText').value.trim();
                if(!reason) return alert("Please write a reason.");
                
                document.getElementById('submitAppealBtn').innerText = "Submitting...";
                document.getElementById('submitAppealBtn').disabled = true;
                
                try {
                    await addDoc(collection(db, "appeals"), {
                        userId: currentUID,
                        userName: myData.name,
                        email: myData.email || "No Email",
                        reason: reason,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert("Appeal Sent! We will review it shortly.");
                    location.reload();
                } catch(e) {
                    console.error(e);
                    alert("Error submitting appeal: " + e.message);
                    document.getElementById('submitAppealBtn').disabled = false;
                }
            };
        }
        return; // Stops loading rest of dashboard
    }
    
    // --- NEW: UNBAN WARNING LOGIC ---
    // This runs if user is NOT banned, but has the 'showUnbanWarning' flag
    if (myData.showUnbanWarning === true) {
        document.body.innerHTML = `
            <div style="height:100vh;width:100vw;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0f172a;color:#fff;text-align:center;font-family:system-ui;padding:20px;">
                <div style="font-size:60px;margin-bottom:10px;">‚ö†Ô∏è</div>
                <h2 style="color:#f59e0b;margin:0;">Account Restored</h2>
                <p style="color:#cbd5e1;margin-top:15px;max-width:400px;line-height:1.5;">
                    Your appeal has been accepted and your account is active again.<br><br>
                    <strong>Please Note:</strong> Any further violations of our Community Guidelines may result in a 
                    <span style="color:#ef4444">permanent ban</span> without appeal.
                </p>
                <button id="ackWarningBtn" style="background:#22c55e;color:white;border:none;padding:12px 24px;border-radius:8px;margin-top:25px;cursor:pointer;font-weight:bold;font-size:14px;">I Understand & Agree</button>
            </div>
        `;
        
        document.getElementById('ackWarningBtn').onclick = async () => {
            // Remove the warning flag
            await updateDoc(doc(db, 'users', currentUID), { showUnbanWarning: false });
            location.reload();
        };
        return;
    }
    // --- END WARNING LOGIC ---

    nameEl.innerHTML = (myData.name || 'User') + (myData.verified ? ' <span class="verified-badge" title="Verified Student">‚òë</span>' : '');
    usernameEl.textContent = myData.username ? '@'+myData.username : '';
    bioEl.textContent = myData.bio || 'No bio added.';
    
    // Toggle
    document.getElementById('availabilityToggle').checked = myData.isAvailable || false;
    
    // Skill Chips
    tagsContainer.innerHTML = '';
    if(myData.skillsOffered && myData.skillsOffered.length > 0){
        myData.skillsOffered.slice(0, 3).forEach(skill => {
            const span = document.createElement('span'); span.className = 'skill-tag'; span.textContent = skill; tagsContainer.appendChild(span);
        });
    }
    
    // Avatar
    if(myData.avatarUrl) { avatarEl.innerHTML = `<img src="${myData.avatarUrl}" style="width:100%;height:100%;object-fit:cover;">`; } 
    else { avatarEl.innerHTML = (myData.name || 'U').charAt(0).toUpperCase(); }
    
    // Stats
    const score = myData.score || 0;
    document.getElementById('scoreEl').textContent = score.toFixed(1);
    document.getElementById('levelEl').textContent = score > 4 ? 'Expert' : (score > 2 ? 'Intermediate' : 'Beginner');
    getDocs(query(collection(db,'requests'), where('receiverId','==',currentUID), where('status','==','pending'))).then(res => document.getElementById('pendingCount').textContent = res.size);
    getDocs(query(collection(db,'requests'), where('receiverId','==',currentUID), where('status','==','accepted'))).then(res => document.getElementById('acceptedCount').textContent = res.size);
  });
}

document.getElementById('availabilityToggle').onchange = async (e) => {
    const isOnline = e.target.checked;
    await updateDoc(doc(db, 'users', currentUID), { isAvailable: isOnline });
    toast(isOnline ? "You are now Online" : "You are now Offline");
};

function subscribeRequests(){
  // Error Catching for Index
  const q = query(collection(db,'requests'), where('receiverId','==',currentUID), where('status','==','pending'), orderBy('createdAt','desc'));
  onSnapshot(q, (qs)=>{
    requestsList.innerHTML = '';
    if(qs.empty) { requestsList.innerHTML = '<div style="padding:20px;text-align:center;color:#64748b;font-size:14px">No pending requests</div>'; return; }
    qs.forEach(docSnap=>{
      const r = docSnap.data();
      const div = document.createElement('div'); div.className='list-item';
      const senderImg = r.senderAvatarUrl ? `<img class="item-avatar" src="${r.senderAvatarUrl}">` : `<div class="item-avatar" style="display:flex;align-items:center;justify-content:center;color:#fff">${(r.senderName||'U').charAt(0)}</div>`;
      div.innerHTML = `<div class="item-left">${senderImg}<div class="item-info"><b>${r.skillOffered} <span style="color:#94a3b8">for</span> ${r.skillRequested}</b><span>From: ${r.senderName}</span></div></div><div><button class="btn btn-primary" style="font-size:11px;padding:6px 12px;margin-right:4px" id="acc-${docSnap.id}">Accept</button><button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;color:#ef4444;border-color:rgba(239,68,68,0.3)" id="rej-${docSnap.id}">Reject</button></div>`;
      requestsList.appendChild(div);
      document.getElementById(`acc-${docSnap.id}`).onclick = ()=> acceptRequest(docSnap.id, r);
      document.getElementById(`rej-${docSnap.id}`).onclick = ()=> updateDoc(doc(db,'requests',docSnap.id), {status:'rejected'});
    });
  }, (error) => {
      console.error(error);
      if(error.message.includes("index")) {
          requestsList.innerHTML = '<div style="color:orange;text-align:center;padding:10px;font-size:12px">‚ö†Ô∏è Missing Index. Check Console (F12) to fix.</div>';
      }
  });
}

async function acceptRequest(id, r){
  await updateDoc(doc(db,'requests',id), { status:'accepted' });
  await addDoc(collection(db,'sessions'), {
    requestId: id, senderId: r.senderId, receiverId: r.receiverId,
    skill: r.skillOffered, status: 'scheduled', createdAt: serverTimestamp(),
    senderAvatarUrl: r.senderAvatarUrl
  });
  toast('Request Accepted'); loadSessions();
}

async function loadSessions(){
  sessionsList.innerHTML = '<div style="color:#64748b;text-align:center;padding:20px;font-size:14px">Loading sessions...</div>';
  try {
      const q1 = query(collection(db,'sessions'), where('receiverId','==',currentUID));
      const snap1 = await getDocs(q1);
      const q2 = query(collection(db,'sessions'), where('senderId','==',currentUID));
      const snap2 = await getDocs(q2);
      const allDocs = [...snap1.docs, ...snap2.docs];
      
      sessionsList.innerHTML = '';
      if(allDocs.length === 0) { sessionsList.innerHTML='<div style="padding:10px;text-align:center;color:#64748b;font-size:13px">No active sessions</div>'; return; }
      
      allDocs.forEach(docSnap=>{
        const s = docSnap.data();
        const div = document.createElement('div'); div.className='list-item';
        
        // Sender/Receiver logic for Display
        const isMeSender = s.senderId === currentUID;
        const displayAvatar = isMeSender ? '/logo.png' : (s.senderAvatarUrl || ''); 
        const avHtml = displayAvatar ? `<img class="item-avatar" src="${displayAvatar}">` : `<div class="item-avatar" style="background:#475569"></div>`;

        div.innerHTML = `<div class="item-left">${avHtml}<div class="item-info"><b>${s.skill}</b><span style="color:#22c55e; font-size:11px;">‚óè Scheduled with ${isMeSender ? 'Partner' : 'You'}</span></div></div><button class="btn btn-primary" onclick="location.href='session.html?req=${s.requestId}&role=${isMeSender ? 'caller' : 'answerer'}'">Join</button>`;
        sessionsList.appendChild(div);
      });
  } catch (err) {
      console.error("Session Error:", err);
      sessionsList.innerHTML = '<div style="color:#ef4444;text-align:center;">Error loading sessions</div>';
  }
}

async function loadMatches(){
  const snap = await getDocs(collection(db,'users'));
  matchesList.innerHTML = '';
  let count = 0;
  snap.forEach(docSnap=>{
    if(docSnap.id === currentUID || count > 4) return;
    const u = docSnap.data();
    count++;
    const div = document.createElement('div'); div.className = 'list-item';
    const uAvatar = u.avatarUrl ? `<img class="item-avatar" src="${u.avatarUrl}">` : `<div class="item-avatar" style="display:flex;align-items:center;justify-content:center;color:#fff">${(u.name||'U').charAt(0)}</div>`;
    div.innerHTML = `<div class="item-left">${uAvatar}<div class="item-info"><b>${u.name}</b><span>${u.university || 'Student'}</span></div></div><button class="btn btn-ghost" style="font-size:11px" onclick="location.href='chat.html?chatWith=${docSnap.id}&name=${encodeURIComponent(u.name)}'">Chat</button>`;
    matchesList.appendChild(div);
  });
}

const reqModal = document.getElementById('requestModal');
document.getElementById('quickRequestBtn').onclick = () => reqModal.classList.add('show');
const mobileBtn = document.getElementById('mobileQuickRequestBtn');
if(mobileBtn) mobileBtn.onclick = () => reqModal.classList.add('show');
document.getElementById('closeRequestModal').onclick = () => reqModal.classList.remove('show');
document.getElementById('sendRequestBtn').onclick = async ()=>{
  const offer = document.getElementById('reqSkillOffer').value;
  const want = document.getElementById('reqSkillWant').value;
  if(!offer || !want) return toast('Fill all fields');
  await addDoc(collection(db,'requests'), {
    senderId: currentUID, senderName: myData.name, senderAvatarUrl: myData.avatarUrl,
    skillOffered: offer, skillRequested: want, status:'pending', createdAt: serverTimestamp()
  });
  toast('Request Created!'); reqModal.classList.remove('show');
};

// --- DELETE ACCOUNT LOGIC ---
document.getElementById('deleteAccBtn').addEventListener('click', async () => {
    const confirm1 = confirm("‚ö†Ô∏è ARE YOU SURE?\n\nThis will permanently delete your account, profile, and chat history. This cannot be undone.");
    if (!confirm1) return;

    const confirm2 = confirm("Last Chance: Do you really want to delete your account?");
    if (!confirm2) return;

    const user = auth.currentUser;
    const btn = document.getElementById('deleteAccBtn');
    
    btn.textContent = "Deleting...";
    btn.disabled = true;

    try {
        await deleteDoc(doc(db, "users", user.uid));
        await deleteUser(user);
        alert("Account deleted successfully.");
        window.location.href = "signup.html";
    } catch (error) {
        console.error("Delete Error:", error);
        if (error.code === 'auth/requires-recent-login') {
            alert("Security Alert: To delete your account, you must have logged in recently.\n\nPlease Log Out and Log In again, then try deleting.");
            await signOut(auth);
            window.location.href = "login.html";
        } else {
            alert("Error deleting account: " + error.message);
            btn.textContent = "üóëÔ∏è Delete Account";
            btn.disabled = false;
        }
    }
});

if(window.innerWidth < 900){ document.getElementById('mobileQuickRequestBtn').style.display='block'; }
window.addEventListener('offline', ()=>document.getElementById('offlineBar').style.display='block');
window.addEventListener('online', ()=>document.getElementById('offlineBar').style.display='none');
</script>
</body>
</html>
