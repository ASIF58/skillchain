<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Edit Profile â€” SwapSkill</title>
  <link rel="icon" type="image/png" href="/logo.png">
  
  <style>
    :root {
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --bg: #0f172a;
      --text: #f8fafc;
      --glass: rgba(30, 41, 59, 0.6);
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }

    body {
      background: radial-gradient(circle at top right, #1e293b, #0f172a);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      position: sticky; top: 0; z-index: 50;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-size: 18px; font-weight: 700; color: #fff; cursor: pointer; }
    
    .btn { padding: 8px 16px; border-radius: 12px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-ghost { background: rgba(255,255,255,0.05); color: #cbd5e1; border: 1px solid var(--border); }
    .btn-ghost:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #2563eb; }

    /* Container */
    .container {
      max-width: 600px; margin: 40px auto; padding: 30px;
      background: var(--glass); backdrop-filter: blur(10px);
      border: 1px solid var(--border); border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    h2 { text-align: center; margin-bottom: 30px; color: #fff; }

    .form-group { margin-bottom: 20px; position: relative; }
    label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 13px; font-weight: 600; }
    
    input, textarea {
      width: 100%; padding: 12px 16px; border-radius: 12px;
      background: rgba(0,0,0,0.2); border: 1px solid var(--border);
      color: #fff; font-size: 14px; outline: none; transition: 0.2s;
    }
    input:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); }
    textarea { resize: vertical; min-height: 100px; }

    /* OTP Section */
    .otp-wrapper {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 16px; border-radius: 12px; margin-bottom: 20px;
      display: none; animation: fadeIn 0.3s ease;
    }
    .otp-btn {
      position: absolute; right: 6px; top: 32px;
      padding: 6px 12px; font-size: 12px; background: var(--primary);
      color: white; border: none; border-radius: 8px; cursor: pointer;
      display: none;
    }

    button[type="submit"] {
      width: 100%; padding: 14px; background: var(--success);
      color: white; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px;
    }
    button[type="submit"]:disabled { background: #475569; cursor: not-allowed; opacity: 0.7; }

    /* Toast */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      background: #0f172a; border: 1px solid var(--border);
      color: #fff; padding: 12px 24px; border-radius: 12px;
      transform: translateY(100px); transition: 0.3s; z-index: 100;
    }
    #toast.show { transform: translateY(0); }

    @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
  </style>
</head>
<body>

<header>
  <div class="brand" onclick="location.href='dashboard.html'">SwapSkill</div>
  <div class="header-right" style="display:flex;gap:10px">
    <button class="btn btn-ghost" onclick="location.href='dashboard.html'">Back</button>
    <button class="btn btn-primary" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="container">
  <h2>Edit Profile</h2>

  <form id="editProfileForm">
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="name" required>
    </div>

    <div class="form-group">
      <label>Username</label>
      <input type="text" id="username" readonly style="opacity:0.6; cursor:not-allowed" title="Username cannot be changed">
    </div>

    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="email" required>
      <button type="button" id="sendOtpBtn" class="otp-btn">Verify Change</button>
    </div>

    <div class="otp-wrapper" id="otpSection">
      <label style="color:#60a5fa">Enter Verification Code sent to new email</label>
      <input type="text" id="otp" placeholder="6-digit code" style="text-align:center; letter-spacing:4px; font-size:18px">
    </div>

    <div class="form-group">
      <label>University / College</label>
      <input type="text" id="university">
    </div>

    <div class="form-group">
      <label>Bio</label>
      <textarea id="bio"></textarea>
    </div>

    <div class="form-group">
      <label>Skills Offered (comma separated)</label>
      <input type="text" id="skills" placeholder="e.g. Java, Python, UI Design">
    </div>

    <button type="submit" id="saveBtn">Save Changes</button>
  </form>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, updateEmail } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwrZVBhR0VSbkbiktvkOsW3iSYJ6PFJ9A",
  authDomain: "swapskill.web.app",
  projectId: "swapskill-6e456"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Init EmailJS
emailjs.init({ publicKey: "QWgG6h3s9AuU-du3B" });

// Elements
const toastEl = document.getElementById('toast');
const nameInput = document.getElementById('name');
const usernameInput = document.getElementById('username');
const emailInput = document.getElementById('email');
const universityInput = document.getElementById('university');
const bioInput = document.getElementById('bio');
const skillsInput = document.getElementById('skills');
const otpSection = document.getElementById('otpSection');
const otpInput = document.getElementById('otp');
const sendOtpBtn = document.getElementById('sendOtpBtn');
const saveBtn = document.getElementById('saveBtn');

let currentUID = null;
let currentEmail = null;
let generatedOtp = null;

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), 3000);
}

onAuthStateChanged(auth, async (user)=>{
  if(!user) return location.href='login.html';
  currentUID = user.uid;
  currentEmail = user.email;

  const snap = await getDoc(doc(db,'users',currentUID));
  if(snap.exists()){
    const d = snap.data();
    nameInput.value = d.name || '';
    usernameInput.value = d.username || '';
    emailInput.value = d.email || user.email;
    universityInput.value = d.university || '';
    bioInput.value = d.bio || '';
    skillsInput.value = d.skillsOffered ? d.skillsOffered.join(', ') : '';
  }
});

// Detect Email Change
emailInput.addEventListener('input', ()=>{
  const val = emailInput.value.trim();
  if(val !== currentEmail && val.length > 5){
    saveBtn.disabled = true;
    saveBtn.innerText = "Verify Email First";
    sendOtpBtn.style.display = "block";
  } else {
    saveBtn.disabled = false;
    saveBtn.innerText = "Save Changes";
    sendOtpBtn.style.display = "none";
    otpSection.style.display = "none";
  }
});

// Send OTP
sendOtpBtn.addEventListener('click', async ()=>{
  const newEmail = emailInput.value.trim();
  sendOtpBtn.innerText = "Sending...";
  sendOtpBtn.disabled = true;
  
  generatedOtp = Math.floor(100000 + Math.random() * 900000);

  try {
    await emailjs.send("service_ae1iubu", "template_yf49r3j", {
      to_email: newEmail,
      otp: generatedOtp,
      to_name: nameInput.value
    });
    
    otpSection.style.display = "block";
    sendOtpBtn.innerText = "Resend";
    sendOtpBtn.disabled = false;
    toast("OTP Code sent!");
  } catch(e) {
    console.error(e);
    toast("Failed to send OTP");
    sendOtpBtn.innerText = "Retry";
    sendOtpBtn.disabled = false;
  }
});

// Save Profile
document.getElementById('editProfileForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const newEmail = emailInput.value.trim();
  saveBtn.disabled = true;
  saveBtn.innerText = "Saving...";

  try {
    // 1. Handle Email Update
    if(newEmail !== currentEmail) {
      if(Number(otpInput.value) !== generatedOtp){
        saveBtn.disabled = false;
        saveBtn.innerText = "Verify Email First";
        return toast("Invalid OTP Code");
      }
      
      // Update Firebase Auth
      await updateEmail(auth.currentUser, newEmail);
      currentEmail = newEmail; // Update local state
    }

    // 2. Update Firestore
    const skillsArr = skillsInput.value.split(',').map(s=>s.trim()).filter(s=>s.length>0);

    await setDoc(doc(db,'users',currentUID), {
      name: nameInput.value.trim(),
      email: newEmail,
      university: universityInput.value.trim(),
      bio: bioInput.value.trim(),
      skillsOffered: skillsArr
    }, { merge: true });

    toast("Profile Updated Successfully!");
    
    // Reset UI state
    otpSection.style.display = 'none';
    sendOtpBtn.style.display = 'none';
    saveBtn.innerText = "Save Changes";
    saveBtn.disabled = false;

  } catch(err) {
    console.error(err);
    if(err.code === 'auth/requires-recent-login'){
      toast("Security: Please Re-Login to change email");
      setTimeout(()=> signOut(auth).then(()=>location.href='login.html'), 2000);
    } else {
      toast("Error: " + err.message);
      saveBtn.disabled = false;
    }
  }
});

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await signOut(auth);
  location.href='login.html';
});
</script>
</body>
</html>
